name: CI for ezapi_miner

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Step 3: Install system dependencies
      - name: Install system packages
        run: |
          sudo apt-get update
          # libaio1 was renamed to libaio-dev in Ubuntu 24.04+
          sudo apt-get install -y unixodbc-dev g++ libaio-dev
      # Step 4: Install Python dependencies
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Compatibility patches for older Flask/Werkzeug and Cryptodome import
          pip install "Flask<2.3" "Werkzeug<3.0"
          pip install pycryptodomex
          pip install -r REQUIREMENTS.txt

      # Step 5: Create dummy .env
      - name: Create dummy .env files
        run: |
          echo "Creating .env files for all environments..."
          echo "FLASK_ENV=development" > .env
          echo "DB_USER=dummy_user" >> .env
          echo "DB_PASS=dummy_pass" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_NAME=test_db" >> .env
          echo "SECRET_KEY=dummysecret" >> .env
          echo "ENV_TYPE=local" >> .env
      # Step 6: Verify syntax
      - name: Verify Python imports
        run: |
          echo "Checking syntax..."
          python -m py_compile app.py
      # Step 7: Smoke test
      - name: Start Flask app (smoke test)
        run: |
          echo "Starting Flask app for quick test..."
          python app.py & sleep 5 && pkill -f app.py
