name: CI for ezapi_miner

on:
  push:
    branches: [ main, stage, refactoredv3 ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev g++ libaio-dev

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install "Flask<2.3" "Werkzeug<3.0" pycryptodomex
          pip install -r REQUIREMENTS.txt

      - name: Create dummy .env files
        run: |
          echo "FLASK_ENV=development" > .env
          echo "DB_USER=dummy_user" >> .env
          echo "DB_PASS=dummy_pass" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_NAME=test_db" >> .env

      - name: Verify Python imports
        run: python -m py_compile app.py

      - name: Smoke test Flask app
        run: |
          python app.py & sleep 5 && pkill -f app.py
        continue-on-error: true

  # DEPLOY TO TEST (refactoredv3)
  deploy-test:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/refactoredv3'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env for test
        run: |
          echo "dbconfig=$test_db_instance" >> .env.test
          echo "pojogenurl=$test_pojogen_url" >> .env.test
          echo "dbpasskey=$test_db_passkey" >> .env.test
          echo "storedprocenv=$test_storedprocenv" >> .env.test
          echo "javacodegen_server_url=$test_javacodegen_url" >> .env.test
          cat .env.test

      - name: Deploy to TEST
        run: |
          echo "Deploying to TEST environment..."
          # add deployment script/ssh/docker/kubectl command here

  # DEPLOY TO STAGE (main)
    deploy-stage:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env for stage
        run: |
          echo "dbconfig=$stage_db_instance" >> .env.stage
          echo "pojogenurl=$stage_pojogen_url" >> .env.stage
          echo "dbpasskey=$stage_db_passkey" >> .env.stage
          echo "storedprocenv=$stage_storedprocenv" >> .env.stage
          echo "javacodegen_server_url=$stage_javacodegen_url" >> .env.stage
          cat .env.stage

      - name: Deploy to STAGE VM
        env:
          HOST: 20.255.48.190
          USER: azureuser
        run: |
          echo "Deploying to STAGE environment..."
          
          # Write private key from GitHub Secret to a file
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Connect and deploy
          ssh -o StrictHostKeyChecking=no -i private_key.pem $USER@$HOST << 'EOF'
            cd /home/azureuser/ezapi_miner || git clone https://github.com/Reshmareshu786/ezapi_miner.git
            cd ezapi_miner
            git pull origin main
            docker-compose down || true
            docker-compose up -d --build
            echo "Deployment complete on STAGE VM!"
          EOF


  # DEPLOY TO MASTER (stage)
  deploy-master:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/stage'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare env for production
        run: |
          echo "dbconfig=$prod_db_instance" >> .env.prod
          echo "pojogenurl=$prod_pojogen_url" >> .env.prod
          echo "dbpasskey=$prod_db_passkey" >> .env.prod
          echo "storedprocenv=$prod_storedprocenv" >> .env.prod
          echo "javacodegen_server_url=$prod_javacodegen_url" >> .env.prod
          cat .env.prod

      - name: Deploy to MASTER
        run: |
          echo "Deploying to PRODUCTION environment..."
          # add prod deploy command here


