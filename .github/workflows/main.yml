name: EzAPI Miner Python CI/CD

on:
  push:
    branches:
      - refactoredv3
      - stage
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # --- Dependency setup ---
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

          # Fixes for older Flask & Werkzeug version compatibility
          pip install "Flask==2.1.2" "Werkzeug<3.0" "itsdangerous<2.1" "click<8.2"

          # Ensure Cryptodome works with both import paths
          pip install pycryptodomex

          # Install all required dependencies
          pip install -r REQUIREMENTS.txt

      # --- Environment file creation ---
      - name: Create environment files
        run: |
          echo "Creating .env files for all environments..."
          # Dummy secrets (replace in actual pipeline)
          echo "dbconfig=dummy" > .env.test
          echo "pojogenurl=http://dummy" >> .env.test
          echo "dbpasskey=secret" >> .env.test
          echo "storedprocenv=test" >> .env.test
          echo "javacodegen_server_url=http://dummy" >> .env.test

      # --- Quick sanity test for app startup ---
      - name: Start Flask app for quick test
        run: |
          echo "Starting Flask app for quick test..."
          python app.py & sleep 5 && pkill -f app.py
        continue-on-error: true

      # --- Deploy to appropriate environment ---
      - name: Deploy - Test (refactoredv3)
        if: github.ref == 'refs/heads/refactoredv3'
        run: |
          echo "Deploying to TEST environment..."
          echo "Using .env.test for deployment"

      - name: Deploy - Stage (master)
        if: github.ref == 'refs/heads/master'
        run: |
          echo "Deploying to STAGE environment..."
          echo "Using .env.stage for deployment"

      - name: Deploy - Prod (stage)
        if: github.ref == 'refs/heads/stage'
        run: |
          echo "Deploying to PROD environment..."
          echo "Using .env.prod for deployment"
